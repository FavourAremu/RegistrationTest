<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Student Registration Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 1s ease;
        }
        
        .form-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        
        .form-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-size: 300% 300%;
            border-radius: 8px;
            z-index: -1;
            animation: borderGradient 15s ease infinite;
            opacity: 0.3;
        }
        
        @keyframes borderGradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        h2 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: inherit;
        }
        
        input[type="date"] {
            position: relative;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            padding: 4px;
            margin: 0 -8px 0 0;
        }
        
        input[type="date"]::-webkit-outer-spin-button,
        input[type="date"]::-webkit-inner-spin-button {
            display: none;
        }
        
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        input[type="radio"] + label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .checkbox-option:hover {
            background-color: #f9f9f9;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        input[type="checkbox"] + label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        button[type="submit"] {
            background-color: #4CAF50;
            color: white;
        }
        
        button[type="submit"]:hover {
            background-color: #45a049;
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
            transform: translateY(-2px);
        }
        
        button[type="submit"]:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        button.cancel {
            background-color: #f44336;
            color: white;
        }
        
        button.cancel:hover {
            background-color: #da190b;
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4);
            transform: translateY(-2px);
        }
        
        button.cancel:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }
        
        /* Success Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: auto;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, -40%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease 0.2s backwards;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .modal-message {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .modal-student-id {
            background: #f0f0f0;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .modal-student-id label {
            display: block;
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .modal-student-id .id-value {
            font-size: 20px;
            font-weight: 700;
            color: #4CAF50;
            font-family: 'Courier New', monospace;
        }
        
        .modal-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-button:hover {
            background: #45a049;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .modal-button:active {
            transform: scale(0.98);
        }
        
        @media (max-width: 600px) {
            .modal-content {
                width: 85%;
                padding: 30px 20px;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .modal-icon {
                font-size: 48px;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .form-container {
                padding: 20px;
                border-radius: 12px;
            }
            
            h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            label {
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            input[type="text"],
            input[type="tel"],
            input[type="email"],
            input[type="date"],
            select {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }
            
            input[type="date"]::-webkit-calendar-picker-indicator {
                width: 40px;
                height: 40px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .radio-option {
                padding: 10px;
                border: 1px solid #eee;
                border-radius: 4px;
                transition: background-color 0.2s;
            }
            
            .radio-option:active {
                background-color: #f0f0f0;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .checkbox-option {
                padding: 12px;
                min-height: 44px;
            }
            
            .button-group {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            
            button {
                padding: 14px;
                font-size: 16px;
                min-height: 48px;
            }
            
            small {
                font-size: 11px;
            }
        }
        
        @media (max-width: 400px) {
            .form-container {
                padding: 15px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            input[type="text"],
            input[type="tel"],
            input[type="email"],
            input[type="date"],
            select {
                padding: 11px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Student Registration</h2>
        <form id="registrationForm">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob" name="dob" required max="2010-12-31" title="Please select a valid date of birth">
                <small style="color: #999; font-size: 12px; margin-top: 4px; display: block;">You must be at least 14 years old to register</small>
            </div>

            <div class="form-group">
                <label>Gender:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="male" name="gender" value="male" required>
                        <label for="male">Male</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="female" name="gender" value="female">
                        <label for="female">Female</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="other" name="gender" value="other">
                        <label for="other">Other</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required>
            </div>

            <div class="form-group">
                <label for="telephone">Telephone (Nigerian):</label>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 0 0 auto; display: flex; align-items: center; padding: 10px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; color: #333;">
                        +234
                    </div>
                    <input type="tel" id="telephone" name="telephone" placeholder="0812 345 6789" required title="Enter a valid Nigerian phone number">
                    <button type="button" id="verifyPhoneBtn" style="flex: 0 0 auto; padding: 10px 16px; min-height: 44px;">Verify</button>
                </div>
                <small id="phoneError" style="color: #d32f2f; display: none; margin-top: 4px;">Please enter a valid 11-digit Nigerian phone number (08xx xxxxxxx or +234xxx xxxxxx)</small>
                <small id="phoneSuccess" style="color: #4CAF50; display: none; margin-top: 4px;">✓ Phone verified</small>
            </div>

            <div class="form-group" id="otpGroup" style="display: none;">
                <label for="otp">Verification Code:</label>
                <input type="text" id="otp" name="otp" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                <small id="otpError" style="color: #d32f2f; display: none; margin-top: 4px;">Invalid code. Please try again.</small>
            </div>

            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" name="email" inputmode="email" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
                <label>Courses:</label>
                <div class="checkbox-group">
                    <div class="checkbox-option">
                        <input type="checkbox" id="mathematics" name="courses" value="mathematics">
                        <label for="mathematics">Mathematics</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="physics" name="courses" value="physics">
                        <label for="physics">Physics</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="biology" name="courses" value="biology">
                        <label for="biology">Biology</label>
                    </div>
                    <div class="checkbox-option">
                        <input type="checkbox" id="chemistry" name="courses" value="chemistry">
                        <label for="chemistry">Chemistry</label>
                    </div>
                </div>
                <small id="coursesError" style="color: #d32f2f; display: none; margin-top: 4px;">Please select at least one course</small>
            </div>

            <div class="button-group">
                <button type="submit">Register</button>
                <button type="button" class="cancel">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">✓</div>
            <h2 class="modal-title">Registration Successful!</h2>
            <p class="modal-message">Your student registration has been submitted successfully.</p>
            <div class="modal-student-id">
                <label>Student ID</label>
                <div class="id-value" id="studentIdDisplay">-</div>
            </div>
            <button class="modal-button" onclick="closeSuccessModal()">Back to Form</button>
        </div>
    </div>

    <script>
        // Dynamic gradient based on time of day with smooth blending
        const setDynamicGradient = () => {
            const now = new Date();
            const hour = now.getHours();
            const minutes = now.getMinutes();
            const timeOfDay = hour + minutes / 60; // Convert to decimal time
            
            const body = document.body;
            let gradient = '';
            
            // Smooth transitions throughout the day
            if (timeOfDay >= 0 && timeOfDay < 6) {
                // Deep night: 0:00 - 6:00
                const progress = timeOfDay / 6;
                gradient = blendGradients(
                    { start: '#0f2027', mid: '#203a43', end: '#2c5364' }, // Deep night
                    { start: '#1a3a3a', mid: '#2d5a5a', end: '#3a7a7a' }, // Pre-dawn
                    progress
                );
            } else if (timeOfDay >= 6 && timeOfDay < 9) {
                // Sunrise: 6:00 - 9:00
                const progress = (timeOfDay - 6) / 3;
                gradient = blendGradients(
                    { start: '#1a3a3a', mid: '#2d5a5a', end: '#3a7a7a' }, // Pre-dawn
                    { start: '#ffd89b', mid: '#ffb366', end: '#19547b' }, // Sunrise
                    progress
                );
            } else if (timeOfDay >= 9 && timeOfDay < 12) {
                // Morning: 9:00 - 12:00
                const progress = (timeOfDay - 9) / 3;
                gradient = blendGradients(
                    { start: '#ffd89b', mid: '#ffb366', end: '#19547b' }, // Sunrise
                    { start: '#667eea', mid: '#715bdb', end: '#764ba2' }, // Afternoon
                    progress
                );
            } else if (timeOfDay >= 12 && timeOfDay < 15) {
                // Early afternoon: 12:00 - 15:00
                const progress = (timeOfDay - 12) / 3;
                gradient = blendGradients(
                    { start: '#667eea', mid: '#715bdb', end: '#764ba2' }, // Purple
                    { start: '#4facfe', mid: '#00f2fe', end: '#667eea' }, // Blue
                    progress
                );
            } else if (timeOfDay >= 15 && timeOfDay < 18) {
                // Late afternoon: 15:00 - 18:00
                const progress = (timeOfDay - 15) / 3;
                gradient = blendGradients(
                    { start: '#4facfe', mid: '#00f2fe', end: '#667eea' }, // Blue
                    { start: '#f093fb', mid: '#f5576c', end: '#fa7e1e' }, // Sunset
                    progress
                );
            } else if (timeOfDay >= 18 && timeOfDay < 21) {
                // Evening: 18:00 - 21:00
                const progress = (timeOfDay - 18) / 3;
                gradient = blendGradients(
                    { start: '#f093fb', mid: '#f5576c', end: '#fa7e1e' }, // Sunset
                    { start: '#d54062', mid: '#6b4d8a', end: '#2c5364' }, // Dusk
                    progress
                );
            } else {
                // Night: 21:00 - 0:00
                const progress = (timeOfDay - 21) / 3;
                gradient = blendGradients(
                    { start: '#d54062', mid: '#6b4d8a', end: '#2c5364' }, // Dusk
                    { start: '#0f2027', mid: '#203a43', end: '#2c5364' }, // Deep night
                    progress
                );
            }
            
            body.style.background = gradient;
        };
        
        // Blend between two gradients based on progress (0-1)
        const blendGradients = (grad1, grad2, progress) => {
            const blendColor = (color1, color2, progress) => {
                const hex = (x) => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };
                
                const r1 = parseInt(color1.slice(1, 3), 16);
                const g1 = parseInt(color1.slice(3, 5), 16);
                const b1 = parseInt(color1.slice(5, 7), 16);
                
                const r2 = parseInt(color2.slice(1, 3), 16);
                const g2 = parseInt(color2.slice(3, 5), 16);
                const b2 = parseInt(color2.slice(5, 7), 16);
                
                const r = Math.round(r1 + (r2 - r1) * progress);
                const g = Math.round(g1 + (g2 - g1) * progress);
                const b = Math.round(b1 + (b2 - b1) * progress);
                
                return '#' + hex(r) + hex(g) + hex(b);
            };
            
            const start = blendColor(grad1.start, grad2.start, progress);
            const mid = blendColor(grad1.mid, grad2.mid, progress);
            const end = blendColor(grad1.end, grad2.end, progress);
            
            return `linear-gradient(135deg, ${start} 0%, ${mid} 50%, ${end} 100%)`;
        };
        
        // Set initial gradient based on time
        setDynamicGradient();
        
        // Update gradient every 30 seconds for smooth continuous blending
        setInterval(setDynamicGradient, 30000);
        
        // Update more frequently (every 10 seconds) for very smooth transitions
        const smoothUpdateInterval = setInterval(setDynamicGradient, 10000);
        
        // Also update when page becomes visible (in case device was sleeping)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setDynamicGradient();
            }
        });

        // Success Modal Functions
        const successModal = document.getElementById('successModal');
        
        const showSuccessModal = (studentId) => {
            document.getElementById('studentIdDisplay').textContent = studentId;
            successModal.style.display = 'block';
            // Prevent background scroll
            document.body.style.overflow = 'hidden';
        };
        
        const closeSuccessModal = () => {
            successModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            form.reset();
            phoneVerified = false;
            otpGroup.style.display = 'none';
            phoneSuccess.style.display = 'none';
            coursesError.style.display = 'none';
            verifyPhoneBtn.disabled = false;
            verifyPhoneBtn.textContent = 'Verify';
        };
        
        // Close modal when clicking outside
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                closeSuccessModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && successModal.style.display === 'block') {
                closeSuccessModal();
            }
        });
        const cancelBtn = document.querySelector('.cancel');
        const dobInput = document.getElementById('dob');
        const phoneInput = document.getElementById('telephone');
        const phoneError = document.getElementById('phoneError');
        const phoneSuccess = document.getElementById('phoneSuccess');
        const verifyPhoneBtn = document.getElementById('verifyPhoneBtn');
        const otpGroup = document.getElementById('otpGroup');
        const otpInput = document.getElementById('otp');
        const otpError = document.getElementById('otpError');
        const coursesError = document.getElementById('coursesError');
        const courseCheckboxes = document.querySelectorAll('input[name="courses"]');

        let phoneVerified = false;
        let generatedOTP = null;

        // Phone number validation (Nigerian format)
        const validatePhoneNumber = (phone) => {
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 11 && digits.startsWith('0')) {
                return /^0[789]\d{8}$/.test(digits);
            }
            
            if (digits.length === 10 && /^[789]\d{9}$/.test(digits)) {
                return true;
            }
            
            if (digits.length === 13 && digits.startsWith('234')) {
                return /^234[789]\d{8}$/.test(digits);
            }
            
            return false;
        };

        
        // Convert phone to standard format (11 digits without leading 0 or 234)
        const normalizePhoneNumber = (phone) => {
            let digits = phone.replace(/\D/g, '');
            if (digits.startsWith('0')) {
                digits = digits.slice(1);
            } else if (digits.startsWith('234')) {
                digits = digits.slice(3);
            }
            return digits;
        };


        // Validate at least one course is selected
        const validateCourses = () => {
            return Array.from(courseCheckboxes).some(cb => cb.checked);
        };

        // Get selected courses
        const getSelectedCourses = () => {
            return Array.from(courseCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        };

        // Course validation on change
        courseCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (validateCourses()) {
                    coursesError.style.display = 'none';
                }
            });
        });

        // Generate random OTP (for demo purposes - in production, send via SMS)
        const generateOTP = () => {
            return Math.floor(100000 + Math.random() * 900000).toString();
        };

        phoneInput.addEventListener('blur', () => {
            if (phoneInput.value && !validatePhoneNumber(phoneInput.value)) {
                phoneError.style.display = 'block';
                phoneInput.style.borderColor = '#d32f2f';
                phoneSuccess.style.display = 'none';
                phoneVerified = false;
            } else if (phoneInput.value) {
                phoneError.style.display = 'none';
                phoneInput.style.borderColor = '#ddd';
            }
        });

        phoneInput.addEventListener('focus', () => {
            phoneError.style.display = 'none';
            phoneInput.style.borderColor = '#ddd';
        });

        // Format Nigerian phone number as user types
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            
            // Allow up to 11 digits (with leading 0) or 10 digits (without)
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            // Format as: 0812 345 6789 or 812 345 6789
            if (value.length > 0) {
                if (value.startsWith('0')) {
                    // Format with leading 0: 0812 345 6789
                    if (value.length <= 4) {
                        value = value;
                    } else if (value.length <= 7) {
                        value = `${value.slice(0, 4)} ${value.slice(4)}`;
                    } else {
                        value = `${value.slice(0, 4)} ${value.slice(4, 7)} ${value.slice(7)}`;
                    }
                } else {
                    // Format without leading 0: 812 345 6789
                    if (value.length <= 3) {
                        value = value;
                    } else if (value.length <= 6) {
                        value = `${value.slice(0, 3)} ${value.slice(3)}`;
                    } else {
                        value = `${value.slice(0, 3)} ${value.slice(3, 6)} ${value.slice(6)}`;
                    }
                }
            }
            e.target.value = value;
            phoneVerified = false;
            phoneSuccess.style.display = 'none';
            otpGroup.style.display = 'none';
            otpInput.value = '';
        });

        // Verify phone button
        verifyPhoneBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!validatePhoneNumber(phoneInput.value)) {
                phoneError.style.display = 'block';
                phoneInput.style.borderColor = '#d32f2f';
                return;
            }

            try {
                verifyPhoneBtn.disabled = true;
                verifyPhoneBtn.textContent = 'Sending Code...';

                const normalizedPhone = normalizePhoneNumber(phoneInput.value);
                // Nigerian format: +234 + 10 digits
                const phoneWithCountry = '+234' + normalizedPhone;

                // Call OTP service
                const response = await fetch('/.netlify/functions/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phoneNumber: phoneWithCountry,
                        action: 'send'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Show OTP input
                    otpGroup.style.display = 'block';
                    otpInput.focus();
                    alert(`Verification code sent to +234${normalizedPhone}!\n\n(Expires in ${result.expiresIn})`);
                    verifyPhoneBtn.textContent = 'Code Sent';
                } else {
                    throw new Error(result.error || 'Failed to send OTP');
                }

            } catch (error) {
                console.error('Error sending OTP:', error);
                alert('Error sending verification code: ' + error.message);
                verifyPhoneBtn.disabled = false;
                verifyPhoneBtn.textContent = 'Verify';
            }
        });

        // Verify OTP
        otpInput.addEventListener('blur', async () => {
            if (otpInput.value && otpInput.value.length === 6) {
                try {
                    const normalizedPhone = normalizePhoneNumber(phoneInput.value);
                    const phoneWithCountry = '+234' + normalizedPhone;

                    const response = await fetch('/.netlify/functions/send-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phoneNumber: phoneWithCountry,
                            action: 'verify',
                            otp: otpInput.value
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        phoneVerified = true;
                        phoneSuccess.style.display = 'block';
                        phoneSuccess.textContent = '✓ Phone verified';
                        otpError.style.display = 'none';
                        otpInput.style.borderColor = '#4CAF50';
                    } else {
                        phoneVerified = false;
                        otpError.style.display = 'block';
                        otpError.textContent = result.error + (result.attemptsRemaining ? ` (${result.attemptsRemaining} attempts left)` : '');
                        otpInput.style.borderColor = '#d32f2f';
                    }
                } catch (error) {
                    console.error('Error verifying OTP:', error);
                    otpError.style.display = 'block';
                    otpError.textContent = 'Error verifying code';
                }
            }
        });

        otpInput.addEventListener('focus', () => {
            otpError.style.display = 'none';
            otpInput.style.borderColor = '#ddd';
        });

        // Validate age on date change
        dobInput.addEventListener('change', () => {
            const birthDate = new Date(dobInput.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            if (age < 14) {
                alert('You must be at least 14 years old to register.');
                dobInput.value = '';
                dobInput.focus();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate date of birth
            if (!dobInput.value) {
                alert('Please select your date of birth');
                dobInput.focus();
                return;
            }

            // Validate phone number
            if (!validatePhoneNumber(phoneInput.value)) {
                alert('Please enter a valid 11-digit Nigerian phone number (08xx xxxxxxx)');
                phoneInput.focus();
                phoneError.style.display = 'block';
                phoneInput.style.borderColor = '#d32f2f';
                return;
            }

            // Validate phone verification
            if (!phoneVerified) {
                alert('Please verify your phone number first');
                otpInput.focus();
                return;
            }

            // Validate courses
            if (!validateCourses()) {
                alert('Please select at least one course');
                coursesError.style.display = 'block';
                return;
            }
            
            // Validate gender
            const selectedGender = document.querySelector('input[name="gender"]:checked');
            if (!selectedGender) {
                alert('Please select a gender');
                return;
            }

            // Collect form data
            const formData = {
                name: document.getElementById('name').value,
                dob: document.getElementById('dob').value,
                gender: selectedGender.value,
                address: document.getElementById('address').value,
                telephone: '+234' + normalizePhoneNumber(phoneInput.value),
                email: document.getElementById('email').value,
                courses: getSelectedCourses(),
                submittedAt: new Date().toISOString()
            };

            try {
                // Disable submit button during request
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // Send data to Netlify serverless function with Neon database
                const response = await fetch('/.netlify/functions/register-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Success message with modal
                const studentId = result.studentId || result.id || 'N/A';
                showSuccessModal(studentId);
                submitBtn.textContent = 'Register';
                submitBtn.disabled = false;

            } catch (error) {
                console.error('Error submitting form:', error);
                alert('Error submitting registration: ' + error.message);
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Register';
                submitBtn.disabled = false;
            }
        });

        cancelBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel? All data will be lost.')) {
                form.reset();
                phoneError.style.display = 'none';
                phoneSuccess.style.display = 'none';
                otpGroup.style.display = 'none';
                coursesError.style.display = 'none';
                phoneVerified = false;
                verifyPhoneBtn.disabled = false;
                verifyPhoneBtn.textContent = 'Verify';
            }
        });
    </script>
</body>
</html>
